name: cd
on: push

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
        working-directory: FIN
      - run: npm test --if-present
        working-directory: FIN

  package_image:
    runs-on: ubuntu-latest
    needs: build_and_test
    steps:
      - uses: actions/checkout@v4
      - run: docker build -t observability-app:ci .
        working-directory: FIN
      - run: docker save observability-app:ci | gzip > app-image.tar.gz
        working-directory: FIN
      - uses: actions/upload-artifact@v4
        with:
          name: app-image
          path: FIN/app-image.tar.gz

  deploy_simulated:
    runs-on: ubuntu-latest
    needs: package_image
    steps:
      - uses: actions/checkout@v4

      - run: docker compose version

      - run: docker compose up -d app prometheus grafana loki promtail jaeger
        working-directory: FIN/observability

      - name: Wait for app health
        run: |
          for i in {1..30}; do
            if curl -sSf http://localhost:8080/healthz >/dev/null; then exit 0; fi
            sleep 2
          done
          echo "App not healthy"; docker compose logs app; exit 1
        working-directory: FIN/observability

      - name: k6 baseline (thresholds gating)
        run: |
          cat > script.js <<'EOF'
          import http from "k6/http";
          import { sleep } from "k6";
          export const options = {
            stages: [
              { duration: "15s", target: 20 },
              { duration: "30s", target: 50 },
              { duration: "15s", target: 0 },
            ],
            thresholds: {
              http_req_duration: ["p(95)<250"],
              http_req_failed: ["rate<0.01"],
            },
          };
          const base = "http://app:8080";
          export default function () {
            const amount = Math.floor(Math.random()*200) + 1;
            const body = JSON.stringify({ amount });
            http.post(`${base}/validate`, body, { headers: { "Content-Type": "application/json" } });
            sleep(0.1);
          }
          EOF
          docker run --rm --network observability_obsnet -v "$PWD:/work" -w /work grafana/k6 run script.js | tee k6-baseline.txt
        working-directory: FIN/observability

      - uses: actions/upload-artifact@v4
        with:
          name: k6-baseline
          path: FIN/observability/k6-baseline.txt

      - name: Prometheus quick check
        run: |
          curl -sSf http://localhost:9090/api/v1/label/__name__/values | head -c 1000 > prometheus-labels.json
        working-directory: FIN/observability

      - uses: actions/upload-artifact@v4
        with:
          name: prometheus-labels
          path: FIN/observability/prometheus-labels.json

      - name: Cleanup
        if: always()
        run: docker compose down -v
        working-directory: FIN/observability